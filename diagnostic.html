<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Turnstile Diagnostic Test</title>
    <style>
        body {
            font-family: system-ui, -apple-system, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-family: monospace;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            padding: 15px 30px;
            background: #4F46E5;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        pre {
            background: #1a1a1a;
            color: #0f0;
            padding: 15px;
            border-radius: 8px;
            overflow-x: auto;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Cloudflare Turnstile Diagnostic</h1>

        <div id="status"></div>

        <div class="status info">
            <strong>Site Key:</strong> 0x4AAAAAACNkgGWXXZi6sAmT<br>
            <strong>Environment:</strong> <span id="env"></span>
        </div>

        <div class="status info">
            <h3>Turnstile Widget</h3>
            <div id="turnstile-container"></div>
        </div>

        <div class="status warning">
            <h3>Test Controls</h3>
            <button id="test-btn" disabled onclick="testSubmission()">Test Submission (Button Disabled Until Turnstile Completes)</button>
            <button onclick="runDiagnostics()">Run Diagnostics</button>
        </div>

        <div class="status info">
            <h3>Console Log</h3>
            <pre id="console-log"></pre>
        </div>
    </div>

    <script>
        const logDiv = document.getElementById('console-log');
        const statusDiv = document.getElementById('status');
        const logs = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString();
            logs.push(`[${timestamp}] [${type.toUpperCase()}] ${message}`);
            logDiv.textContent = logs.join('\n');
        }

        function addStatus(message, type = 'info') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            statusDiv.appendChild(div);
        }

        // Show environment
        const protocol = window.location.protocol;
        const host = window.location.host;
        document.getElementById('env').textContent = `${protocol}//${host}`;

        // Warn if on file:// protocol
        if (protocol === 'file:') {
            addStatus('‚ö†Ô∏è <strong>Warning:</strong> You are on <code>file://</code> protocol. Turnstile invisible mode requires <strong>HTTPS</strong> or <strong>localhost</strong>.<br><br><strong>Solution:</strong><br><code>python3 -m http.server 8000</code><br>Then open: http://localhost:8000/diagnostic.html', 'warning');
            log('‚ö†Ô∏è file:// protocol detected - Turnstile may not work', 'warning');
        } else if (protocol === 'https:' || host.startsWith('127.0.0.1') || host.startsWith('localhost')) {
            addStatus('‚úì <strong>Protocol OK:</strong> Using ' + protocol + ' - Turnstile should work', 'success');
            log('‚úì Protocol compatible with Turnstile', 'success');
        } else {
            addStatus('‚ö†Ô∏è <strong>Warning:</strong> Turnstile requires HTTPS or localhost. Your domain (' + host + ') may not be authorized in Cloudflare dashboard.', 'warning');
        }

        // Intercept console methods
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn,
            debug: console.debug
        };

        console.log = (...args) => {
            log(args.join(' '), 'info');
            originalConsole.log(...args);
        };
        console.error = (...args) => {
            log(args.join(' '), 'error');
            originalConsole.error(...args);
        };
        console.warn = (...args) => {
            log(args.join(' '), 'warning');
            originalConsole.warn(...args);
        };
        console.debug = (...args) => {
            log(args.join(' '), 'debug');
            originalConsole.debug(...args);
        };

        // Turnstile callback
        window.turnstileCallback = function(token) {
            log('‚úì Turnstile callback triggered!', 'success');
            log(`Token length: ${token.length} characters`, 'info');
            log(`Token prefix: ${token.substring(0, 20)}...`, 'info');

            // Store token
            window.turnstileToken = token;

            // Enable button
            const testBtn = document.getElementById('test-btn');
            if (testBtn) {
                testBtn.disabled = false;
                log('‚úì Submit button enabled', 'success');
            }

            addStatus('‚úì <strong>Turnstile Verified!</strong><br>The widget has been successfully completed. The submit button is now enabled.', 'success');
        };

        async function testSubmission() {
            log('Testing submission...', 'info');

            if (!window.turnstileToken) {
                log('‚úó No Turnstile token available', 'error');
                addStatus('‚úó <strong>Error:</strong> No Turnstile token available', 'error');
                return;
            }

            const payload = new URLSearchParams({
                email: 'test_hash_value',
                'cf-turnstile-response': window.turnstileToken
            });

            log(`Payload: ${payload.toString()}`, 'info');

            try {
                const response = await fetch('https://compute-exchange-lead-capture.cx-portal.workers.dev', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded'
                    },
                    body: payload.toString()
                });

                const responseText = await response.text();

                if (response.ok) {
                    log(`‚úì Success! Status: ${response.status}`, 'success');
                    log(`Response: ${responseText}`, 'info');
                    addStatus(`‚úì <strong>Worker Accepted Request!</strong><br>Status: ${response.status}<br>Response: ${responseText}`, 'success');
                } else {
                    log(`‚úó Failed! Status: ${response.status}`, 'error');
                    log(`Response: ${responseText}`, 'info');
                    addStatus(`‚úó <strong>Worker Rejected Request</strong><br>Status: ${response.status}<br>${responseText}`, 'error');
                }
            } catch (error) {
                log(`‚úó Network error: ${error.message}`, 'error');
                addStatus(`‚úó <strong>Network Error:</strong><br>${error.message}`, 'error');
            }
        }

        function runDiagnostics() {
            log('=== Running Diagnostics ===', 'info');
            log(`User Agent: ${navigator.userAgent}`, 'info');
            log(`Cookies Enabled: ${navigator.cookieEnabled}`, 'info');
            log(`Do Not Track: ${navigator.doNotTrack}`, 'info');
            log(`Language: ${navigator.language}`, 'info');

            // Check if Turnstile loaded
            if (typeof turnstile !== 'undefined') {
                log('‚úì Turnstile script loaded', 'success');
                addStatus('‚úì <strong>Turnstile Script:</strong> Loaded successfully', 'success');
            } else {
                log('‚úó Turnstile script NOT loaded', 'error');
                addStatus('‚úó <strong>Turnstile Script:</strong> Failed to load. Check CSP and network.', 'error');
            }

            // Check if widget rendered
            const container = document.getElementById('turnstile-container');
            if (container && container.children.length > 0) {
                log('‚úì Turnstile widget rendered', 'success');
                addStatus('‚úì <strong>Turnstile Widget:</strong> Rendered successfully', 'success');
            } else {
                log('‚úó Turnstile widget NOT rendered', 'error');
                addStatus('‚úó <strong>Turnstile Widget:</strong> Failed to render', 'error');
            }

            // Check token
            if (window.turnstileToken) {
                log('‚úì Turnstile token available', 'success');
            } else {
                log('‚ö†Ô∏è Turnstile token NOT yet available (waiting for user to complete challenge)', 'warning');
            }
        }

        // Load Turnstile
        log('Loading Turnstile script...', 'info');

        const script = document.createElement('script');
        script.src = 'https://challenges.cloudflare.com/turnstile/v0/api.js';
        script.async = true;
        script.defer = true;
        script.onload = () => {
            log('‚úì Turnstile script loaded', 'success');
            addStatus('‚úì <strong>Script Loaded:</strong> Turnstile API script loaded successfully', 'success');

            // Render widget
            log('Rendering Turnstile widget...', 'info');
            if (typeof turnstile !== 'undefined') {
                turnstile.render('#turnstile-container', {
                    sitekey: '0x4AAAAAACNkgGWXXZi6sAmT',
                    theme: 'light',
                    callback: (token) => {
                        window.turnstileCallback(token);
                    },
                    'error-callback': (error) => {
                        log('‚úó Turnstile error callback fired', 'error');
                        log(`Error code: ${error}`, 'error');

                        let errorMsg = '‚úó <strong>Turnstile Error:</strong><br>';
                        errorMsg += `Error Code: ${error}<br><br>`;

                        if (error === '110200') {
                            errorMsg += '<strong>This means:</strong> Domain not authorized in Cloudflare dashboard<br><br>';
                            errorMsg += '<strong>Solution:</strong><br>';
                            errorMsg += '1. Go to <a href="https://dash.cloudflare.com/" target="_blank">Cloudflare Dashboard</a><br>';
                            errorMsg += '2. Navigate to: Turnstile ‚Üí Your Site Key (0x4AAAAAACNkgGWXXZi6sAmT)<br>';
                            errorMsg += '3. Click "Settings" or "Edit"<br>';
                            errorMsg += '4. Add these domains:<br>';
                            errorMsg += '   &nbsp; ‚Ä¢ localhost<br>';
                            errorMsg += '   &nbsp; ‚Ä¢ 127.0.0.1<br>';
                            errorMsg += '   &nbsp; ‚Ä¢ Your actual domain (e.g., bdtec.ai)<br>';
                            errorMsg += '5. Save and refresh this page';
                        } else if (error === '110130') {
                            errorMsg += '<strong>This means:</strong> Not on HTTPS or localhost<br>';
                            errorMsg += 'Use a local server: <code>python3 -m http.server 3000</code>';
                        } else {
                            errorMsg += 'Check Cloudflare dashboard for domain configuration';
                        }

                        addStatus(errorMsg, 'error');
                    },
                    'expired-callback': () => {
                        log('‚ö†Ô∏è Turnstile token expired', 'warning');
                        addStatus('‚ö†Ô∏è <strong>Token Expired:</strong> Please refresh the page', 'warning');
                    }
                });
            }
        };
        script.onerror = () => {
            log('‚úó Failed to load Turnstile script', 'error');
            addStatus('‚úó <strong>Script Failed:</strong> Turnstile API script failed to load. Check CSP and browser console.', 'error');
        };

        document.head.appendChild(script);

        // Initial status
        log('Diagnostic tool initialized', 'info');
        addStatus('<strong>Diagnostic Tool Ready</strong><br>Complete the Turnstile challenge above, then click "Test Submission"', 'info');

        // Run diagnostics after 2 seconds
        setTimeout(runDiagnostics, 2000);
    </script>
</body>
</html>
